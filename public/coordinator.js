function int2hex(e){for(var r=e.toString(16);r.length<8;)r="0"+r;return r.substr(6,2)+r.substr(4,2)+r.substr(2,2)+r.substr(0,2)}function urlencode(e){var r=[];for(var t in e)r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r.join("&")}function ajax(e){function r(r,t){t||(t=null),r.error?"function"==typeof e.error&&e.error(r.error,r,t):"function"==typeof e.success&&e.success(r.result,r,t),"function"==typeof e.complete&&e.complete(r,t)}if(e.method=e.method||"GET",e.url){var t=e.url;e.query&&(t="object"==typeof e.query?t+"?"+urlencode(e.query):t+"?"+e.query),e.type=e.type||"json";var o=new XMLHttpRequest;if(o.open(e.method,t,!0),o.onreadystatechange=function(){if(4==o.readyState){var e={status:500,error:"The server is currently unavailable.",result:null};try{e=JSON.parse(o.responseText)}catch(t){}r(e,o)}},"json"===e.type&&"setRequestHeader"in o&&o.setRequestHeader("Accept","application/json"),e.body){var n=e.body;"object"==typeof n&&("overrideMimeType"in o&&o.overrideMimeType("application/x-www-form-urlencoded"),"setRequestHeader"in o&&o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n=urlencode(n)),o.send(n)}else o.send()}}function workerMessage(e){var r=e.data;if("string"==typeof r)ajax({method:"POST",url:"/api/submit",body:{header:r.substr(0,160),scrypt:r.substr(160,64)}});else{var t=e.target.workSize/((Date.now()-e.target.startedWork)/1e3);e.target.rateHistory.unshift(t),e.target.rateHistory.length>5&&e.target.rateHistory.pop(),e.target.workSize=Math.floor(5*t),workers.sendWork(e.target)}}function updateBalance(){ajax({url:"/api/balance",success:function(e){e=Math.floor(1e3*e)/1e3,document.getElementById("balance-amount").innerHTML=e}})}function notify(e,r){var t=document.createElement("div"),o="notice"+Math.random().toString().substr(2);t.id=o,t.className="notice"+(r?" "+r:""),t.innerHTML=e,document.getElementById("header").appendChild(t),setTimeout(function(){t.parentNode.removeChild(t)},5e3)}function withdraw(){return ajax({url:"/api/withdraw",success:function(e){notify(e,"success")},error:function(e){notify(e,"error")}}),!1}var workers=[];workers.workCache=!1,workers.awaitingWork=[];var rate=document.getElementById("rate"),pnaclBlock=document.getElementById("pnacl-block");workers.addWorker=function(){if(!(workers.length>=10)){switch(workers.type=navigator.mimeTypes["application/x-pnacl"]?"PNACL":"JS",workers.type){case"JS":var e=new Worker("/public/worker.js");e.workSize=1e3,e.rateHistory=[],e.addEventListener("message",workerMessage,!0),workers.push(e),workers.sendWork(e);break;case"PNACL":var e=document.createElement("embed");e.workSize=1e3,e.rateHistory=[],e.setAttribute("src","/public/module.nmf"),e.setAttribute("type","application/x-pnacl"),e.addEventListener("load",function(){workers.sendWork(e)},!1),e.addEventListener("message",workerMessage,!1),pnaclBlock.appendChild(e),workers.push(e)}workers.type&&!workers.workCache&&workers.getWork(),document.getElementById("intensity-label").innerHTML=workers.length}},workers.removeWorker=function(){if(0!=workers.length){switch(workers.type){case"JS":workers.pop().terminate();break;case"PNACL":var e=workers.pop();e.parentNode.removeChild(e)}document.getElementById("intensity-label").innerHTML=workers.length}},workers.sendWork=function(e){if(!workers.workCache)return workers.awaitingWork.push(e);e.startedWork=Date.now();var r=workers.workCache.data+int2hex(workers.workCache.nonce)+int2hex(workers.workCache.nonce+=e.workSize);e.postMessage(r)},workers.pollWork=function(){ajax({url:"/api/work",query:{poll:"true"},success:function(e){e&&(workers.workCache.data=e,workers.workCache.nonce=0),workers.pollWork()},error:function(){setTimeout(workers.pollWork,1e4)}})},workers.getWork=function(){ajax({url:"/api/work",success:function(e){if(e){workers.workCache||(workers.workCache={}),workers.workCache.data=e,workers.workCache.nonce=0;for(var r=0;r<workers.awaitingWork.length;r+=1)workers.sendWork(workers.awaitingWork[r]);workers.awaitingWork.length=0}workers.pollWork()},error:function(){setTimeout(workers.getWork,5e3)}})},workers.getHashRate=function(){var e,r,t,o,n=0;for(e=0;e<workers.length;e+=1)r=workers[e],r.rateHistory&&r.rateHistory.length>0&&(n+=1);if(0==n)return!1;var s=0;for(e=0;e<workers.length;e+=1)if(r=workers[e].rateHistory,r.length>0){for(o=0,t=0;t<r.length;t+=1)o+=r[t];s+=o/r.length}return s},workers.updateHashRate=function(){if(0==workers.length)return rate.innerHTML="<strong>-</strong><span>Not Mining</span>";var e=workers.getHashRate();return e?(rate.innerHTML="<strong>"+(e/1e3).toFixed(3)+"</strong><span>Kilohashes</span>",void 0):rate.innerHTML="<strong>-</strong><span>Warming Up</span>"},setInterval(workers.updateHashRate,2500);var doButtons=!1;if("undefined"==typeof Worker)notify("Mining is not supported in this browser. Please update to the latest version."),ga("send","event","nosupport","noworker",{nonInteraction:1});else if("undefined"==typeof Uint8Array)notify("Mining is not supported in this browser. Please update to the latest version."),ga("send","event","nosupport","notypedarrays",{nonInteraction:1});else if(/(iphone|ipad|android|ios)/i.test(window.navigator.userAgent)){var btn=document.getElementById("start-btn");btn.style.display="block",btn.onclick=function(){confirm("Mining on mobile may have unexpected side effects, including battery usage and heat production. Please use carefully!")&&(workers.addWorker(),workers.updateHashRate(),btn.parentNode.removeChild(btn),document.getElementById("intensity").style.display="block")},doButtons=!0}else workers.addWorker(),workers.updateHashRate(),document.getElementById("intensity").style.display="block",doButtons=!0;doButtons&&(document.getElementById("up-btn").onclick=function(){workers.length<10?workers.addWorker():notify("Ten is the maxiumum intensity.")},document.getElementById("down-btn").onclick=function(){workers.length>0&&workers.removeWorker()}),updateBalance(),setInterval(updateBalance,6e4),document.getElementById("email-form").addEventListener("submit",function(e){"preventDefault"in e&&e.preventDefault();var r=document.getElementById("email").value;return ajax({method:"post",url:"/api/email",body:{email:r},success:function(){notify("Your email has been saved.","success"),updateBalance()},error:function(e){notify(e,"error")}}),!1},!1),setInterval(function(){var e=workers.getHashRate();e&&e>1&&(e=Math.floor(e),ga("send","event","hashrate",workers.type.toLowerCase(),workers.length,e))},12e4);